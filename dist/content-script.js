const addPasswordManagerButton=()=>{console.log("ðŸš€ Content script loaded on:",location.href);let e=document.getElementsByTagName("input");const t=e.length;for(let o=0;o<t;o++){const t=e.item(o);if("password"!==t.type)continue;console.log("ðŸ” Found password input, adding password manager button...");const n=document.createElement("button");n.innerHTML="ðŸ”’",n.style.position="absolute",n.style.right="10px",n.style.top="50%",n.style.transform="translateY(-50%)",n.style.width="30px",n.style.height="30px",n.style.border="none",n.style.borderRadius="50%",n.style.backgroundColor="#3498db",n.style.color="white",n.style.cursor="pointer",n.style.fontSize="14px",n.style.zIndex="1000",n.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",n.title="Password Manager",t.getBoundingClientRect();const s=t.offsetParent||document.body;"static"===getComputedStyle(s).position&&(s.style.position="relative"),s.appendChild(n);const l=document.createElement("button");l.innerHTML="ðŸ”",l.style.position="absolute",l.style.width="30px",l.style.height="30px",l.style.border="none",l.style.borderRadius="50%",l.style.backgroundColor="#9b59b6",l.style.color="white",l.style.cursor="pointer",l.style.fontSize="14px",l.style.zIndex="1000",l.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",l.title="Autofill Password",s.appendChild(l);const r=t.offsetTop,a=t.offsetLeft,d=t.offsetWidth,i=t.offsetHeight;l.style.position="absolute",l.style.left=a+d-80+"px",l.style.top=r+i/2-15+"px",n.style.position="absolute",n.style.left=a+d-118+"px",n.style.top=r+i/2-10+"px",n.dataset.inputId=o,l.dataset.inputId=o,n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("ðŸ” Password manager button clicked, showing popup..."),createPasswordPopup(t,o)}),l.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),console.log("ðŸ” Autofill icon button clicked"),l.disabled=!0,l.innerHTML="â³";try{const e=new URL(location.href).hostname.replace("www.","");if(!chrome.runtime?.id)throw new Error("Extension context invalidated. Please reload the page.");const o=await new Promise((t,o)=>{const n=chrome.runtime.connect({name:"autofillPort"});let s=!1;n.onMessage.addListener(e=>{"password"===e.type?(s=!0,n.disconnect(),t(e.data)):"error"===e.type&&(s=!0,n.disconnect(),o(new Error(e.error)))}),n.onDisconnect.addListener(()=>{s||o(new Error("Port disconnected"))}),n.postMessage({action:"getPasswordForSite",data:{websiteName:e}})});o?(t.value=o,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),l.innerHTML="âœ…",setTimeout(()=>{l.innerHTML="ðŸ”",l.disabled=!1},2e3)):(l.innerHTML="âŒ",setTimeout(()=>{l.innerHTML="ðŸ”",l.disabled=!1},2e3))}catch(e){console.error("âŒ Autofill icon error:",e),l.innerHTML="âŒ",setTimeout(()=>{l.innerHTML="ðŸ”",l.disabled=!1},2e3)}});break}},createPasswordPopup=(e,t)=>{console.log("ðŸ” Creating password popup for input:",t);const o=document.createElement("div");o.style.position="fixed",o.style.zIndex="10000";const n=e.getBoundingClientRect();o.style.left=n.left+window.scrollX+"px",o.style.top=n.top+window.scrollY-150+"px",o.style.backgroundColor="#2c3e50",o.style.width="320px",o.style.padding="18px",o.style.borderRadius="8px",o.style.border="1px solid #3498db",o.style.color="white",o.style.fontFamily="Arial, sans-serif",o.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)";const s=document.createElement("h3");s.innerText="ðŸ”’ Password Manager",s.style.margin="0 0 12px 0",s.style.color="#3498db",s.style.fontSize="16px";const l=generateSecurePassword(),r=document.createElement("input");r.type="text",r.placeholder="Label (e.g., Work, Personal)",r.value="Default",r.style.width="100%",r.style.padding="10px",r.style.marginBottom="8px",r.style.backgroundColor="#34495e",r.style.color="#ecf0f1",r.style.border="1px solid #3498db",r.style.borderRadius="4px",r.style.fontSize="14px",r.style.boxSizing="border-box";const a=document.createElement("input");a.type="text",a.value=l,a.readOnly=!1,a.placeholder="Edit password or use generated one",a.style.width="100%",a.style.padding="10px",a.style.marginBottom="12px",a.style.backgroundColor="#34495e",a.style.color="#ecf0f1",a.style.border="1px solid #3498db",a.style.borderRadius="4px",a.style.fontSize="14px",a.style.fontFamily="monospace",a.style.boxSizing="border-box",a.style.cursor="text";const d=document.createElement("div");d.style.display="flex",d.style.gap="8px",d.style.flexWrap="wrap",d.style.marginTop="8px";const i=document.createElement("button");i.innerText="ðŸ”„ Regenerate",i.style.backgroundColor="#3498db",i.style.color="white",i.style.border="none",i.style.padding="10px 12px",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.flex="1",i.style.fontSize="13px",i.style.fontWeight="600";const c=document.createElement("button");c.innerText="ðŸ’¾ Save",c.style.backgroundColor="#27ae60",c.style.color="white",c.style.border="none",c.style.padding="10px 12px",c.style.borderRadius="4px",c.style.cursor="pointer",c.style.flex="1",c.style.fontSize="13px",c.style.fontWeight="600";const p=document.createElement("button");p.innerText="âœ•",p.style.backgroundColor="#95a5a6",p.style.color="white",p.style.border="none",p.style.padding="10px 12px",p.style.borderRadius="4px",p.style.cursor="pointer",p.style.width="40px",p.style.fontSize="13px",d.appendChild(i),d.appendChild(c),d.appendChild(p),o.appendChild(s),o.appendChild(r),o.appendChild(a),o.appendChild(d),i.addEventListener("click",()=>{const e=generateSecurePassword();a.value=e,console.log("ðŸ”„ Regenerated password")}),p.addEventListener("click",()=>{o.remove()}),document.addEventListener("click",t=>{o.contains(t.target)||t.target===e||o.remove()},{once:!0}),document.body.appendChild(o),c.addEventListener("click",async()=>{const t=a.value,n=r.value.trim()||"Default";if(t.length<8)alert("Password must be at least 8 characters.");else{c.disabled=!0,c.innerText="ðŸ’¾ Saving...";try{console.log("ðŸ”„ Saving password to Enhanced Nillion collection...");const s=new URL(location.href).hostname.replace("www.",""),l=await chrome.runtime.sendMessage({action:"saveToEnhancedNillion",data:{websiteName:s,websiteUrl:location.href,password:t,label:n}});console.log("âœ… Password ACTUALLY saved to Enhanced Nillion!"),console.log("ðŸ“ Nillion Record ID:",l),e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),o.remove();const r=document.createElement("div");r.style.position="fixed",r.style.top="20px",r.style.right="20px",r.style.backgroundColor="#27ae60",r.style.color="white",r.style.padding="12px 20px",r.style.borderRadius="6px",r.style.zIndex="10001",r.style.fontFamily="Arial, sans-serif",r.innerText="ðŸ”’ Password saved to Nillion!",document.body.appendChild(r),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},3e3)}catch(e){console.error("âŒ Failed to save to Enhanced Nillion:",e),alert("âŒ Failed to save to Enhanced Nillion - please try again"),c.disabled=!1,c.innerText="ðŸ’¾ Save"}}})},createPasswordListPopup=async(e,t)=>{console.log("ðŸ” Creating password list popup with data:",e),document.querySelectorAll("[data-password-popup]").forEach(e=>e.remove());const o=document.createElement("div");o.setAttribute("data-password-popup","true"),o.style.position="fixed",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.width="400px",o.style.maxHeight="500px",o.style.backgroundColor="#2c3e50",o.style.border="2px solid #3498db",o.style.borderRadius="12px",o.style.color="white",o.style.fontFamily="Arial, sans-serif",o.style.zIndex="20000",o.style.boxShadow="0 8px 32px rgba(0,0,0,0.5)",o.style.overflow="hidden";const n=document.createElement("div");n.style.padding="15px 20px",n.style.backgroundColor="#3498db",n.style.borderBottom="1px solid #2980b9";const s=document.createElement("h3");s.innerText="ðŸ”’ All Saved Passwords",s.style.margin="0",s.style.color="white",s.style.fontSize="18px";const l=document.createElement("button");l.innerHTML="âœ•",l.style.position="absolute",l.style.top="10px",l.style.right="15px",l.style.background="none",l.style.border="none",l.style.color="white",l.style.fontSize="20px",l.style.cursor="pointer",l.style.padding="5px",n.appendChild(s),n.appendChild(l);const r=document.createElement("div");if(r.style.padding="20px",r.style.maxHeight="400px",r.style.overflowY="auto",e&&e.data&&Array.isArray(e.data)){console.log("ðŸ“‹ Processing password data...");for(const n of e.data)try{const e=await chrome.storage.local.get(["nillion_user_key","nillion_user_did"]);if(!e.nillion_user_key||!e.nillion_user_did)continue;const{SecretVaultUserClient:s}=await import("@nillion/secretvaults"),{Keypair:l}=await import("@nillion/nuc");let a;try{const t=e.nillion_user_key.startsWith("0x")?e.nillion_user_key:"0x"+e.nillion_user_key;a=l.from(t)}catch(t){a=l.from(e.nillion_user_key)}const d=await s.from({baseUrls:["https://nildb-stg-n1.nillion.network","https://nildb-stg-n2.nillion.network","https://nildb-stg-n3.nillion.network"],keypair:a,blindfold:{operation:"store"}}),i=await d.readData({collection:n.collection,document:n.document}),c=i?.data;if(c&&c.name&&c.password){const e=c.name.split("_").slice(1).join("_"),n=document.createElement("div");n.style.padding="12px",n.style.marginBottom="8px",n.style.backgroundColor="#34495e",n.style.borderRadius="6px",n.style.border="1px solid #4a5f7a";const s=document.createElement("div");s.style.fontWeight="bold",s.style.color="#3498db",s.style.marginBottom="4px",s.innerText=`ðŸŒ ${e}`;const l=document.createElement("div");l.style.display="flex",l.style.alignItems="center",l.style.gap="8px",l.style.marginBottom="8px";const a=document.createElement("div");a.style.fontFamily="monospace",a.style.fontSize="12px",a.style.color="#ecf0f1",a.style.backgroundColor="#2c3e50",a.style.padding="6px",a.style.borderRadius="3px",a.style.wordBreak="break-all",a.style.flex="1",a.innerText=c.password;const d=document.createElement("button");d.innerHTML="ðŸ“‹",d.style.backgroundColor="#3498db",d.style.color="white",d.style.border="none",d.style.padding="6px 8px",d.style.borderRadius="4px",d.style.cursor="pointer",d.style.fontSize="12px",d.title="Copy password",d.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(c.password),d.innerHTML="âœ…",d.style.backgroundColor="#27ae60",setTimeout(()=>{d.innerHTML="ðŸ“‹",d.style.backgroundColor="#3498db"},2e3)}catch(e){const t=document.createElement("textarea");t.value=c.password,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),d.innerHTML="âœ…",d.style.backgroundColor="#27ae60",setTimeout(()=>{d.innerHTML="ðŸ“‹",d.style.backgroundColor="#3498db"},2e3)}}),l.appendChild(a),l.appendChild(d);const i=document.createElement("div");i.style.display="flex",i.style.gap="8px";const p=document.createElement("button");p.innerText="Use This Password",p.style.backgroundColor="#27ae60",p.style.color="white",p.style.border="none",p.style.padding="6px 12px",p.style.borderRadius="4px",p.style.cursor="pointer",p.style.fontSize="12px",p.style.flex="1",p.addEventListener("click",()=>{t.value=c.password,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),o.remove();const n=document.createElement("div");n.style.position="fixed",n.style.top="20px",n.style.right="20px",n.style.backgroundColor="#27ae60",n.style.color="white",n.style.padding="12px 20px",n.style.borderRadius="6px",n.style.zIndex="10001",n.style.fontFamily="Arial, sans-serif",n.innerText=`ðŸ”’ Password for ${e} applied!`,document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)});const y=document.createElement("button");y.innerText="ðŸŽ² Generate New",y.style.backgroundColor="#f39c12",y.style.color="white",y.style.border="none",y.style.padding="6px 12px",y.style.borderRadius="4px",y.style.cursor="pointer",y.style.fontSize="12px",y.style.flex="1",y.addEventListener("click",()=>{const e=generateSecurePassword();t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),o.remove();const n=document.createElement("div");n.style.position="fixed",n.style.top="20px",n.style.right="20px",n.style.backgroundColor="#f39c12",n.style.color="white",n.style.padding="12px 20px",n.style.borderRadius="6px",n.style.zIndex="10001",n.style.fontFamily="Arial, sans-serif",n.innerText="ðŸŽ² New password generated!",document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}),i.appendChild(p),i.appendChild(y),n.appendChild(s),n.appendChild(l),n.appendChild(i),r.appendChild(n)}}catch(e){console.error("âŒ Error processing password item:",e);continue}if(0===r.children.length){const e=document.createElement("div");e.style.textAlign="center",e.style.color="#95a5a6",e.style.padding="20px",e.innerText="No saved passwords found",r.appendChild(e)}}else{const e=document.createElement("div");e.style.textAlign="center",e.style.color="#e74c3c",e.style.padding="20px",e.innerText="Failed to load passwords",r.appendChild(e)}o.appendChild(n),o.appendChild(r),document.body.appendChild(o),l.addEventListener("click",()=>{o.remove()}),o.addEventListener("click",e=>{e.target===o&&o.remove()})},generateSecurePassword=()=>{let e="";for(let t=0;t<8;t++)e+="@#$abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*"[Math.floor(73*Math.random())];return e};setTimeout(()=>{addPasswordManagerButton()},500);